<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Script Executor - Live Terminal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üêç Python Script Executor</h1>
            <p>Upload and execute Python scripts with live terminal output</p>
        </header>

        <div class="upload-section">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-label">
                        <span id="fileName">Choose a .py file</span>
                    </label>
                    <input type="file" id="fileInput" name="file" accept=".py" required>
                </div>
                <button type="submit" id="executeBtn" class="btn-execute">Execute Script</button>
            </form>
        </div>

        <div id="loadingIndicator" class="loading hidden">
            <div class="spinner"></div>
            <p>Uploading and starting execution...</p>
        </div>

        <div id="terminalSection" class="terminal-section hidden">
            <div class="terminal-header">
                <div class="terminal-buttons">
                    <span class="terminal-button close"></span>
                    <span class="terminal-button minimize"></span>
                    <span class="terminal-button maximize"></span>
                </div>
                <div class="terminal-title">
                    <span id="terminalFilename">Terminal</span>
                    <span id="executionStatus" class="execution-status running">‚óè Running</span>
                </div>
                <div class="terminal-time">
                    <span id="executionTime">0.000s</span>
                </div>
            </div>
            <div id="terminal" class="terminal-body">
                <div class="terminal-prompt">$ python <span id="scriptName"></span></div>
            </div>
        </div>

        <div class="info-section">
            <h3>‚ÑπÔ∏è Information</h3>
            <ul>
                <li>Maximum file size: 50MB</li>
                <li>Execution timeout: 10 seconds</li>
                <li>Live streaming output as script runs</li>
                <li>All Python code executed without restrictions</li>
                <li>Files automatically deleted after execution</li>
            </ul>
        </div>

        <footer>
            <a href="/logs" target="_blank" class="btn-logs">View Execution Logs</a>
        </footer>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const executeBtn = document.getElementById('executeBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const terminalSection = document.getElementById('terminalSection');
        const terminal = document.getElementById('terminal');
        const terminalFilename = document.getElementById('terminalFilename');
        const scriptName = document.getElementById('scriptName');
        const executionTime = document.getElementById('executionTime');
        const executionStatus = document.getElementById('executionStatus');

        let startTime;
        let timerInterval;

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
            } else {
                fileName.textContent = 'Choose a .py file';
            }
        });

        function updateTimer() {
            if (startTime) {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(3);
                executionTime.textContent = elapsed + 's';
            }
        }

        function appendToTerminal(content, type = 'stdout') {
            const line = document.createElement('div');
            line.className = 'terminal-line ' + type;
            line.textContent = content;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!file.name.endsWith('.py')) {
                alert('Only .py files are allowed');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            executeBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            terminalSection.classList.add('hidden');

            try {
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await uploadResponse.json();

                if (!uploadData.success) {
                    alert('Upload error: ' + (uploadData.error || 'Unknown error'));
                    executeBtn.disabled = false;
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                loadingIndicator.classList.add('hidden');
                terminalSection.classList.remove('hidden');
                
                terminal.innerHTML = '<div class="terminal-prompt">$ python ' + uploadData.filename + '</div>';
                
                terminalFilename.textContent = uploadData.filename;
                scriptName.textContent = uploadData.filename;
                
                executionStatus.className = 'execution-status running';
                executionStatus.textContent = '‚óè Running';
                
                startTime = Date.now();
                executionTime.textContent = '0.000s';
                timerInterval = setInterval(updateTimer, 50);

                const eventSource = new EventSource('/execute/' + encodeURIComponent(uploadData.filepath));

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'stdout') {
                            appendToTerminal(data.content, 'stdout');
                        } else if (data.type === 'stderr') {
                            appendToTerminal(data.content, 'stderr');
                        } else if (data.type === 'error') {
                            appendToTerminal(data.content, 'error');
                        } else if (data.type === 'complete') {
                            clearInterval(timerInterval);
                            executionTime.textContent = data.execution_time + 's';
                            executionStatus.className = 'execution-status complete';
                            executionStatus.textContent = '‚úì Complete';
                            eventSource.close();
                            executeBtn.disabled = false;
                        }
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                };

                eventSource.onerror = function(error) {
                    clearInterval(timerInterval);
                    executionStatus.className = 'execution-status error';
                    executionStatus.textContent = '‚úó Error';
                    eventSource.close();
                    executeBtn.disabled = false;
                };

            } catch (err) {
                clearInterval(timerInterval);
                alert('Network error: ' + err.message);
                executeBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
